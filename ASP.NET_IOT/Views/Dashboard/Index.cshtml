@model ASP.NET_IoT.Models.Mqtt.SensorPayload
@{
    ViewData["Title"] = "Dashboard";
    var area = ViewData["Area"] as string;
    var zone = ViewData["Zone"] as string;
}

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2>Dashboard: <span class="text-primary">@area</span> / <span class="text-info">@zone</span></h2>
            <hr />
        </div>
    </div>

    @if (Model == null)
    {
        <div id="status-container" class="alert alert-warning">
            <h4 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Sensor Not Found</h4>
            <p>目前快取中沒有此感測器的資料。請確保設備已發送 MQTT 訊息至 <code>sensors/@area/@zone</code>。</p>
            <p class="mb-0">正在等待實時數據...</p>
        </div>
    }

    <div id="dashboard-content" class="@(Model == null ? "d-none" : "")">
        <div class="row g-4">
            <!-- Moisture -->
            <div class="col-md-3">
                <div class="card h-100 border-0 shadow-sm bg-light">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">Moisture</h6>
                        <h3 id="val-moisture" class="display-6 text-primary">@(Model?.Readings?.Moisture ?? 0)%</h3>
                    </div>
                </div>
            </div>
            <!-- Temperature -->
            <div class="col-md-3">
                <div class="card h-100 border-0 shadow-sm bg-light">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">Temperature</h6>
                        <h3 id="val-temperature" class="display-6 text-danger">@((Model?.Readings?.Temperature ?? 0).ToString("F2"))°C</h3>
                    </div>
                </div>
            </div>
            <!-- Light -->
            <div class="col-md-3">
                <div class="card h-100 border-0 shadow-sm bg-light">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">Light</h6>
                        <h3 id="val-light" class="display-6 text-warning">@(Model?.Readings?.Light ?? 0) lx</h3>
                    </div>
                </div>
            </div>
            <!-- pH -->
            <div class="col-md-3">
                <div class="card h-100 border-0 shadow-sm bg-light">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">pH Level</h6>
                        <h3 id="val-ph" class="display-6 text-success">@((Model?.Readings?.Ph ?? 0).ToString("F2"))</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">Device Info</div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Device ID <span id="val-deviceid" class="badge bg-secondary font-monospace">@(Model?.DeviceId ?? "N/A")</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Battery <span id="val-battery" class="badge @(Model?.Battery < 20 ? "bg-danger" : "bg-success")">@(Model?.Battery ?? 0)%</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Signal <span id="val-signal" class="badge bg-info">@(Model?.SignalStrength ?? 0) dBm</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Uptime <span id="val-uptime" class="text-muted small">@(Model?.Uptime ?? 0)s</span>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">Metadata</div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Firmware <span id="val-firmware" class="text-muted">@(Model?.Firmware ?? "N/A")</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Last Updated <span id="val-lastupdated" class="text-muted small">@DateTime.Now.ToString("HH:mm:ss")</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/signalr/dist/browser/signalr.js"></script>
    <script>
        const targetTopic = "sensors/@area/@zone/readings";
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/sensorHub")
            .withAutomaticReconnect()
            .build();

        connection.on("ReceiveReading", function (topic, payload) {
            if (topic === targetTopic) {
                console.log("Updating dashboard data...");
                try {
                    const data = JSON.parse(payload);
                    
                    // Show content if it was hidden
                    document.getElementById("dashboard-content").classList.remove("d-none");
                    const statusContainer = document.getElementById("status-container");
                    if (statusContainer) statusContainer.classList.add("d-none");

                    // Update values
                    if (data.readings) {
                        document.getElementById("val-moisture").innerText = data.readings.moisture + "%";
                        document.getElementById("val-temperature").innerText = (data.readings.temperature).toFixed(2) + "°C";
                        document.getElementById("val-light").innerText = data.readings.light + " lx";
                        document.getElementById("val-ph").innerText = (data.readings.ph).toFixed(2);
                    }

                    document.getElementById("val-deviceid").innerText = data.device_id;
                    document.getElementById("val-battery").innerText = data.battery + "%";
                    document.getElementById("val-signal").innerText = data.signal_strength + " dBm";
                    document.getElementById("val-uptime").innerText = data.uptime + "s";
                    document.getElementById("val-firmware").innerText = data.firmware;
                    document.getElementById("val-lastupdated").innerText = new Date().toLocaleTimeString();

                    // Update battery color
                    const batteryBadge = document.getElementById("val-battery");
                    batteryBadge.className = data.battery < 20 ? "badge bg-danger" : "badge bg-success";

                } catch (e) {
                    console.error("Error parsing real-time payload", e);
                }
            }
        });

        connection.start().then(function () {
            console.log("SignalR Connected to Hub");
        }).catch(function (err) {
            return console.error(err.toString());
        });
    </script>
}
